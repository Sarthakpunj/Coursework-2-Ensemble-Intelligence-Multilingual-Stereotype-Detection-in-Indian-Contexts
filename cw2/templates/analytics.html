<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Analytics Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: var(--primary);
            font-weight: 700;
        }
        
        .chart-container {
            background: #F9FAFB;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .chart-description {
            font-size: 0.9rem;
            color: #6B7280;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary) 0%, #3B82F6 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .metric-label {
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .nav-btn {
            margin: 10px 5px;
        }
        
        .info-box {
            background: #DBEAFE;
            border-left: 4px solid #3B82F6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Comprehensive Model Performance & Carbon Tracking</p>
            <a href="/" class="btn btn-outline-primary nav-btn">
                <i class="fas fa-arrow-left"></i> Back to Main
            </a>
            <button class="btn btn-primary nav-btn" onclick="loadAnalytics()">
                <i class="fas fa-sync"></i> Refresh Data
            </button>
        </div>

        <div id="noData" class="info-box text-center">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h5>No Analysis Data Available</h5>
            <p>Go to the <a href="/">main page</a> and analyze some text first!</p>
        </div>

        <div id="analyticsContent" style="display: none;">
            <!-- Summary Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="totalSentences">0</div>
                        <div class="metric-label">Total Sentences</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                        <div class="metric-value" id="stereotypeCount">0</div>
                        <div class="metric-label">Stereotypes Detected</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
                        <div class="metric-value" id="safeCount">0</div>
                        <div class="metric-label">Safe Sentences</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);">
                        <div class="metric-value" id="biasRatio">0%</div>
                        <div class="metric-label">Bias Ratio</div>
                    </div>
                </div>
            </div>

            <!-- Chart Grid -->
            <div class="row">
                <!-- Model Comparison Heatmap -->
                <div class="col-md-12">
                    <div class="chart-container">
                        <div class="chart-title">üìà Model Predictions Heatmap</div>
                        <div class="chart-description">
                            Shows how each model (ALBERT, MuRIL, Ensemble) scored every sentence. 
                            Red = High stereotype probability, Green = Low stereotype probability
                        </div>
                        <div id="heatmapChart"></div>
                    </div>
                </div>

                <!-- Model Score Distribution -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-title">üìä Model Score Distribution</div>
                        <div class="chart-description">
                            Distribution of stereotype scores across all models. 
                            Shows how confident each model is in its predictions.
                        </div>
                        <div id="distributionChart"></div>
                    </div>
                </div>

                <!-- Detection Summary -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-title">üéØ Detection Summary</div>
                        <div class="chart-description">
                            Breakdown of stereotypes vs safe sentences. 
                            Shows overall detection results.
                        </div>
                        <div id="summaryChart"></div>
                    </div>
                </div>

                <!-- Language Distribution -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-title">üåê Language Distribution</div>
                        <div class="chart-description">
                            Distribution of languages detected in analyzed sentences.
                            Shows multilingual capability (English, Hindi, Hinglish).
                        </div>
                        <div id="languageChart"></div>
                    </div>
                </div>

                <!-- Trigger Words (Not implemented) -->
                <!-- <div class="col-md-6">
                    <div class="chart-container">
                        <div class="chart-title">üîë Trigger Words Found</div>
                        <div class="chart-description">
                            Count of different types of trigger words.
                            Generalizations, negative traits, and identity group mentions.
                        </div>
                        <div id="triggerChart"></div>
                    </div>
                </div> -->

                <!-- Model Agreement -->
                <div class="col-md-12">
                    <div class="chart-container">
                        <div class="chart-title">ü§ù Model Agreement Analysis</div>
                        <div class="chart-description">
                            Shows agreement between models for each sentence.
                            High agreement = all models agree, Low = models disagree.
                        </div>
                        <div id="agreementChart"></div>
                    </div>
                </div>

                <!-- Carbon Tracking -->
                <div class="col-md-12">
                    <div class="chart-container">
                        <div class="chart-title">üå± Carbon Footprint</div>
                        <div class="chart-description">
                            Environmental impact tracking. Shows CO‚ÇÇ emissions from model inference
                            and equivalent comparisons (phone charges, distance driven).
                        </div>
                        <div id="carbonChart"></div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 id="carbonInferences">0</h5>
                                    <small class="text-muted">Total Inferences</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 id="carbonEmissions">0g</h5>
                                    <small class="text-muted">CO‚ÇÇ Emitted</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 id="carbonPhone">0</h5>
                                    <small class="text-muted">Phone Charges</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 id="carbonDriven">0m</h5>
                                    <small class="text-muted">Distance Driven</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Performance Comparison -->
                <div class="col-md-12">
                    <div class="chart-container">
                        <div class="chart-title">‚öñÔ∏è Model Performance Comparison</div>
                        <div class="chart-description">
                            Average scores and detection rates for each model.
                            Compare ALBERT, MuRIL, and Ensemble performance.
                        </div>
                        <div id="performanceChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        async function loadAnalytics() {
            try {
                // Fetch analytics data
                const response = await fetch('/analytics/data');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Analytics error:', errorData);
                    throw new Error(errorData.error || 'No data available');
                }
                
                const data = await response.json();
                console.log('Analytics data loaded:', data);

                // Fetch carbon data
                const carbonResponse = await fetch('/carbon');
                const carbonData = await carbonResponse.json();
                console.log('Carbon data loaded:', carbonData);

                // Hide no data message, show content
                document.getElementById('noData').style.display = 'none';
                document.getElementById('analyticsContent').style.display = 'block';

                // Update metrics
                document.getElementById('totalSentences').textContent = data.total;
                document.getElementById('stereotypeCount').textContent = data.stereotypes;
                document.getElementById('safeCount').textContent = data.safe;
                document.getElementById('biasRatio').textContent = 
                    ((data.stereotypes / data.total) * 100).toFixed(1) + '%';

                // Create charts
                createHeatmap(data);
                createDistribution(data);
                createSummary(data);
                createLanguageChart(data);
                // createTriggerChart(data);  // Not implemented in backend
                createAgreementChart(data);
                createCarbonChart(carbonData);
                createPerformanceChart(data);

            } catch (error) {
                console.error('Load analytics failed:', error);
                document.getElementById('noData').style.display = 'block';
                document.getElementById('analyticsContent').style.display = 'none';
            }
        }

        function createHeatmap(data) {
            const n = data.model_scores.albert.length;
            const sentences = Array.from({length: n}, (_, i) => `S${i+1}`);

            const heatmapData = [{
                z: [
                    data.model_scores.albert,
                    data.model_scores.muril,
                    data.model_scores.ensemble
                ],
                x: sentences,
                y: ['ALBERT', 'MuRIL', 'Ensemble'],
                type: 'heatmap',
                colorscale: 'RdYlGn_r',
                zmin: 0,
                zmax: 1,
                text: [
                    data.model_scores.albert.map(v => (v * 100).toFixed(0) + '%'),
                    data.model_scores.muril.map(v => (v * 100).toFixed(0) + '%'),
                    data.model_scores.ensemble.map(v => (v * 100).toFixed(0) + '%')
                ],
                texttemplate: '%{text}',
                textfont: {size: 10},
                hovertemplate: 'Model: %{y}<br>Sentence: %{x}<br>Score: %{z:.1%}<extra></extra>'
            }];

            const layout = {
                margin: {l: 100, r: 50, t: 20, b: 50},
                height: 250,
                xaxis: {title: 'Sentences'},
                yaxis: {title: 'Models'}
            };

            Plotly.newPlot('heatmapChart', heatmapData, layout, {responsive: true});
        }

        function createDistribution(data) {
            const traces = [
                {
                    x: data.model_scores.albert,
                    type: 'histogram',
                    name: 'ALBERT',
                    marker: {color: '#3B82F6'},
                    opacity: 0.6
                },
                {
                    x: data.model_scores.muril,
                    type: 'histogram',
                    name: 'MuRIL',
                    marker: {color: '#8B5CF6'},
                    opacity: 0.6
                },
                {
                    x: data.model_scores.ensemble,
                    type: 'histogram',
                    name: 'Ensemble',
                    marker: {color: '#10B981'},
                    opacity: 0.6
                }
            ];

            const layout = {
                barmode: 'overlay',
                xaxis: {title: 'Stereotype Score', range: [0, 1]},
                yaxis: {title: 'Count'},
                height: 350,
                margin: {l: 50, r: 50, t: 20, b: 50},
                showlegend: true
            };

            Plotly.newPlot('distributionChart', traces, layout, {responsive: true});
        }

        function createSummary(data) {
            const summaryData = [{
                values: [data.stereotypes, data.safe],
                labels: ['‚ö†Ô∏è Stereotypes', '‚úÖ Safe'],
                type: 'pie',
                marker: {
                    colors: ['#EF4444', '#10B981']
                },
                textinfo: 'label+percent',
                textfont: {size: 14},
                hovertemplate: '%{label}<br>Count: %{value}<br>Percentage: %{percent}<extra></extra>'
            }];

            const layout = {
                height: 350,
                margin: {l: 20, r: 20, t: 20, b: 20},
                showlegend: false
            };

            Plotly.newPlot('summaryChart', summaryData, layout, {responsive: true});
        }

        function createLanguageChart(data) {
            const languages = Object.keys(data.languages);
            const counts = Object.values(data.languages);
            
            const languageData = [{
                values: counts,
                labels: languages,
                type: 'pie',
                marker: {
                    colors: ['#3B82F6', '#F59E0B', '#8B5CF6']
                },
                textinfo: 'label+percent',
                hovertemplate: '%{label}<br>Count: %{value}<extra></extra>'
            }];

            const layout = {
                height: 350,
                margin: {l: 20, r: 20, t: 20, b: 20}
            };

            Plotly.newPlot('languageChart', languageData, layout, {responsive: true});
        }

        function createTriggerChart(data) {
            const categories = Object.keys(data.triggers);
            const counts = Object.values(data.triggers);

            const triggerData = [{
                x: categories.map(c => c.replace('_', ' ').toUpperCase()),
                y: counts,
                type: 'bar',
                marker: {
                    color: ['#3B82F6', '#EF4444', '#F59E0B']
                },
                text: counts,
                textposition: 'outside'
            }];

            const layout = {
                xaxis: {title: 'Trigger Category'},
                yaxis: {title: 'Count'},
                height: 350,
                margin: {l: 50, r: 50, t: 20, b: 100},
                showlegend: false
            };

            Plotly.newPlot('triggerChart', triggerData, layout, {responsive: true});
        }

        function createAgreementChart(data) {
            const n = data.model_scores.albert.length;
            const sentences = Array.from({length: n}, (_, i) => `S${i+1}`);
            
            // Calculate agreement (all models agree on classification)
            const agreements = sentences.map((_, i) => {
                const a = data.model_scores.albert[i] > 0.5 ? 1 : 0;
                const m = data.model_scores.muril[i] > 0.5 ? 1 : 0;
                const e = data.model_scores.ensemble[i] > 0.5 ? 1 : 0;
                return (a === m && m === e) ? 1 : 0;
            });

            const agreementData = [{
                x: sentences,
                y: agreements,
                type: 'bar',
                marker: {
                    color: agreements.map(a => a === 1 ? '#10B981' : '#EF4444')
                },
                text: agreements.map(a => a === 1 ? 'Agree' : 'Disagree'),
                textposition: 'outside',
                hovertemplate: 'Sentence: %{x}<br>Agreement: %{text}<extra></extra>'
            }];

            const layout = {
                xaxis: {title: 'Sentences'},
                yaxis: {title: 'Agreement', tickvals: [0, 1], ticktext: ['Disagree', 'Agree']},
                height: 300,
                margin: {l: 50, r: 50, t: 20, b: 50},
                showlegend: false
            };

            Plotly.newPlot('agreementChart', agreementData, layout, {responsive: true});
        }

        function createCarbonChart(carbon) {
            // Update text metrics
            document.getElementById('carbonInferences').textContent = carbon.inference_count;
            document.getElementById('carbonEmissions').textContent = carbon.total_emissions_g.toFixed(4) + 'g';
            document.getElementById('carbonPhone').textContent = carbon.equivalent_phone_charges.toFixed(2);
            document.getElementById('carbonDriven').textContent = (carbon.equivalent_km_driven * 1000).toFixed(1) + 'm';

            // Create gauge chart
            const gaugeData = [{
                type: "indicator",
                mode: "gauge+number",
                value: carbon.total_emissions_g,
                number: {suffix: 'g', font: {size: 32}},
                title: {text: "CO‚ÇÇ Emissions", font: {size: 16}},
                gauge: {
                    axis: {range: [0, Math.max(10, carbon.total_emissions_g * 1.5)]},
                    bar: {color: "#10B981"},
                    steps: [
                        {range: [0, 5], color: "#D1FAE5"},
                        {range: [5, 10], color: "#FEF3C7"}
                    ],
                    threshold: {
                        line: {color: "#EF4444", width: 3},
                        thickness: 0.8,
                        value: carbon.total_emissions_g
                    }
                }
            }];

            const layout = {
                height: 250,
                margin: {l: 50, r: 50, t: 50, b: 20}
            };

            Plotly.newPlot('carbonChart', gaugeData, layout, {responsive: true});
        }

        function createPerformanceChart(data) {
            const avgAlbert = data.model_scores.albert.reduce((a, b) => a + b, 0) / data.model_scores.albert.length;
            const avgMuril = data.model_scores.muril.reduce((a, b) => a + b, 0) / data.model_scores.muril.length;
            const avgEnsemble = data.model_scores.ensemble.reduce((a, b) => a + b, 0) / data.model_scores.ensemble.length;

            const performanceData = [{
                x: ['ALBERT', 'MuRIL', 'Ensemble'],
                y: [avgAlbert * 100, avgMuril * 100, avgEnsemble * 100],
                type: 'bar',
                marker: {
                    color: ['#3B82F6', '#8B5CF6', '#10B981']
                },
                text: [
                    (avgAlbert * 100).toFixed(1) + '%',
                    (avgMuril * 100).toFixed(1) + '%',
                    (avgEnsemble * 100).toFixed(1) + '%'
                ],
                textposition: 'outside'
            }];

            const layout = {
                xaxis: {title: 'Model'},
                yaxis: {title: 'Average Stereotype Score (%)', range: [0, 100]},
                height: 350,
                margin: {l: 50, r: 50, t: 20, b: 50},
                showlegend: false
            };

            Plotly.newPlot('performanceChart', performanceData, layout, {responsive: true});
        }

        // Auto-load on page load
        window.addEventListener('load', loadAnalytics);
    </script>
</body>
</html>